# EcoBoard 完整測試指南

## 📋 測試準備

### 1. 確認環境狀態
✅ **資料庫遷移已完成**
```
✓ Database tables created successfully
✓ Migration completed successfully
```

### 2. 啟動伺服器

#### 後端伺服器
```powershell
cd D:\source\EcoBoard
npm run dev
```

**預期輸出**:
```
Server is running on port 3000
Database connected successfully
```

#### 前端伺服器（新終端機視窗）
```powershell
cd D:\source\EcoBoard\client
npm run dev
```

**預期輸出**:
```
  VITE v5.0.8  ready in 1234 ms

  ➜  Local:   http://localhost:5173/
  ➜  Network: http://192.168.x.x:5173/
```

### 3. 測試帳號準備
建議準備以下測試帳號：
- **管理員帳號**: `admin` / `password`
- **成員帳號 1**: `user1` / `password`
- **成員帳號 2**: `user2` / `password`

---

## 🧪 功能測試

### 測試 1: 工作項目刪除功能
**目標**: 驗證工作項目可以被正確刪除，權限檢查正常

#### 步驟
1. 以 `user1` 登入
2. 導航至「新增工作項目」頁面
3. 新增一個測試工作項目：
   ```
   工作內容: 測試刪除功能 - 完成登入頁面設計
   ```
4. 確認工作項目出現在右側面板
5. 點擊工作項目卡片上的「🗑️ 刪除」按鈕
6. **驗證**: 工作項目立即從列表中消失

#### 權限測試
7. 以 `admin` 登入
8. 導航至「每日工作更新」
9. 找到 `user2` 的工作項目
10. 嘗試刪除（管理員應該可以刪除任何人的項目）
11. **驗證**: 刪除成功

#### 預期結果
- ✅ 自己的工作項目可以刪除
- ✅ 管理員可以刪除任何人的工作項目
- ✅ 一般成員無法刪除他人的工作項目（前端不顯示刪除按鈕）
- ✅ 刪除後列表即時更新

#### 失敗排查
- 如果刪除按鈕未出現 → 檢查 `WorkItems.tsx` 是否包含刪除按鈕代碼
- 如果刪除失敗 → F12 開啟 DevTools，檢查 Network 標籤的錯誤訊息
- 如果權限錯誤 → 檢查後端 `workitem.service.ts` 的 `deleteWorkItem()` 函數

---

### 測試 2: WorkItems 即時閱讀與 AI 總結
**目標**: 驗證雙欄布局、AI 即時總結、Markdown 渲染

#### 步驟
1. 登入並導航至「新增工作項目」
2. **驗證布局**:
   - 左側應佔 60% 寬度（對話面板）
   - 右側應佔 40% 寬度（總結面板）
   - 兩側有適當間隔

3. 在對話框輸入：
   ```
   我今天要完成三件事：
   1. 修復登入頁面的 bug
   2. 設計新的儀表板 UI
   3. 撰寫 API 文件
   ```

4. 觀察右側總結面板：
   - **驗證**: 應顯示「正在生成總結...」或 loading 動畫
   - **驗證**: 總結內容應包含 Markdown 格式（標題、列表等）
   - **驗證**: 工作項目應顯示時間戳記（例：09:30）

5. 再新增一個工作項目：
   ```
   下午要開會討論專案進度，需要準備簡報
   ```

6. **驗證**: 右側總結自動更新，包含新的工作項目

#### Markdown 格式測試
7. 檢查 AI 總結中的格式：
   - **標題**: 應顯示為較大字體，藍色主題
   - **列表**: 應有適當縮排和符號
   - **粗體**: 應正確加粗
   - **連結**: 如有應可點擊

#### 預期結果
- ✅ 雙欄布局正確（60/40）
- ✅ 新增工作項目後總結即時更新
- ✅ Markdown 格式正確渲染
- ✅ 時間戳記正確顯示
- ✅ 編輯和刪除按鈕可見

#### 失敗排查
- 如果布局錯誤 → 檢查瀏覽器窗口大小，嘗試全螢幕
- 如果總結不更新 → 檢查 Console 是否有 API 錯誤
- 如果 Markdown 未渲染 → 確認 `react-markdown` 已安裝：`npm list react-markdown`

---

### 測試 3: WorkItems 對話式編輯
**目標**: 驗證可以透過對話編輯工作項目

#### 步驟
1. 在 WorkItems 頁面找到一個已存在的工作項目
2. 點擊工作項目卡片上的「✏️ 編輯」按鈕
3. **驗證**: 對話框應進入編輯模式
   - 顯示提示：「您正在編輯工作項目: [原內容]」
   - 或類似的上下文提示

4. 在對話框輸入修改指示：
   ```
   請改成：完成登入頁面的響應式設計和 dark mode 支援
   ```

5. **驗證**: AI 理解修改意圖並確認
6. 確認修改後，工作項目內容應更新為新內容
7. **驗證**: 右側總結面板重新生成

#### 預期結果
- ✅ 點擊編輯按鈕進入編輯模式
- ✅ 對話框顯示當前內容作為上下文
- ✅ 可以透過自然語言修改內容
- ✅ 修改後立即反映在列表中
- ✅ 總結重新生成

#### 失敗排查
- 如果編輯按鈕不顯示 → 檢查 `WorkItems.tsx` 是否有編輯按鈕
- 如果編輯無效 → 檢查 Network 標籤，確認 PUT API 被呼叫
- 如果內容未更新 → 嘗試刷新頁面

---

### 測試 4: 團隊管理功能增強
**目標**: 驗證團隊編輯、刪除、角色管理、成員移除功能

#### 步驟 A: 編輯團隊資訊
1. 以管理員身份登入
2. 導航至「團隊管理」頁面
3. 找到團隊名稱旁的「✏️」按鈕
4. 點擊進入編輯模式
5. 修改團隊名稱為：`測試團隊 - 已修改`
6. 點擊「✓」儲存
7. **驗證**: 團隊名稱立即更新

8. 同樣方式編輯團隊描述
9. **驗證**: 描述也成功更新

#### 步驟 B: 統計卡片
10. 檢查頁面頂部的統計卡片：
    - **成員總數**: 應顯示正確數字
    - **管理員數量**: 應顯示正確數字
11. **驗證**: 數字與成員列表一致

#### 步驟 C: 角色管理
12. 找到一個「成員」角色的使用者
13. 點擊「提升為管理員」按鈕（或類似文字）
14. **驗證**: 
    - 該使用者的角色徽章變為「管理員」（藍色）
    - 統計卡片的管理員數量 +1

15. 嘗試點擊自己的角色切換按鈕
16. **驗證**: 應該無法切換（防誤操作）

#### 步驟 D: 移除成員
17. 找到一個測試成員
18. 點擊「移除」按鈕
19. **驗證**: 該成員立即從列表中消失
20. **驗證**: 統計卡片的成員總數 -1

#### 步驟 E: 刪除團隊（⚠️ 危險操作）
> **注意**: 此操作會刪除團隊的所有資料，僅在測試環境執行

21. 找到「刪除團隊」按鈕（應為紅色警告樣式）
22. 點擊刪除
23. **驗證**: 團隊被刪除，返回團隊列表
24. **驗證**: 資料庫中該團隊的所有關聯資料也被刪除：
    - work_updates
    - work_items
    - standup_meetings
    - checkins
    - team_members

#### 預期結果
- ✅ 團隊名稱和描述可以編輯
- ✅ 統計卡片顯示正確數字
- ✅ 可以提升成員為管理員
- ✅ 可以降級管理員為成員
- ✅ 管理員無法修改自己的角色
- ✅ 可以移除成員
- ✅ 刪除團隊後級聯刪除所有關聯資料

#### 失敗排查
- 如果編輯無效 → 檢查 Console 錯誤，確認 PUT API 成功
- 如果統計數字錯誤 → 刷新頁面重新載入
- 如果無法切換角色 → 檢查是否為管理員身份
- 如果級聯刪除失敗 → 檢查資料庫 foreign key 設定

---

### 測試 6: 修復打卡準確性問題
**目標**: 驗證時區修復，打卡狀態正確

#### 步驟
1. 檢查當前台灣時間（應為 UTC+8）
2. 登入並導航至「打卡」頁面
3. 執行打卡操作
4. **驗證**: 打卡時間應顯示台灣當地時間（非 UTC）

#### 跨日測試（關鍵）
5. 如果當前時間接近午夜（23:50-00:10），執行此測試：
   - 在 23:59 前打卡
   - **驗證**: 記錄為當日打卡
   - 等待至 00:01
   - 刷新頁面
   - **驗證**: 前一日打卡記錄保留，今日顯示未打卡

6. 查看「今日工作項目」列表
7. **驗證**: 只顯示今日（台灣時間）的工作項目

#### 模擬測試（如無法跨日測試）
8. 使用資料庫直接插入測試：
   ```sql
   -- 插入昨日的打卡記錄
   INSERT INTO checkins (team_id, user_id, checkin_date, checkin_time)
   VALUES (1, 1, CURRENT_DATE - INTERVAL '1 day', NOW() - INTERVAL '1 day');

   -- 插入今日的打卡記錄
   INSERT INTO checkins (team_id, user_id, checkin_date, checkin_time)
   VALUES (1, 1, CURRENT_DATE, NOW());
   ```

9. 刷新頁面
10. **驗證**: 只顯示今日打卡狀態

#### 預期結果
- ✅ 打卡時間使用台灣時區（UTC+8）
- ✅ 跨午夜時日期計算正確
- ✅ 今日工作項目篩選正確
- ✅ 打卡狀態顯示準確（已打卡/未打卡）

#### 失敗排查
- 如果時間不正確 → 檢查伺服器系統時間
- 如果跨日錯誤 → 檢查 `checkin.service.ts` 的 `getTodayDate()` 函數
- 如果篩選錯誤 → 檢查 `workitem.service.ts` 的日期比對邏輯

---

### 測試 7: 工作進度權限管理
**目標**: 驗證管理員可查看全隊進度，成員只能查看自己

#### 步驟 A: 管理員測試
1. 以管理員身份登入
2. 導航至「每日工作更新」頁面
3. **驗證**: 頁面頂部應顯示「查看所有成員進度」核取方塊

4. **未勾選狀態**:
   - **驗證**: 只顯示自己的工作項目
   - 記錄顯示的項目數量

5. **勾選「查看所有成員進度」**:
   - **驗證**: 顯示團隊所有成員的工作項目
   - **驗證**: 項目數量應 ≥ 未勾選時的數量
   - **驗證**: 每個項目應顯示成員姓名

6. 切換勾選狀態數次
7. **驗證**: 每次切換列表即時更新

#### 步驟 B: 一般成員測試
8. 登出，以一般成員 `user1` 登入
9. 導航至「每日工作更新」頁面
10. **驗證**: 
    - 不應顯示「查看所有成員進度」核取方塊
    - 只顯示自己的工作項目
    - 無法查看其他成員的進度

#### 預期結果
- ✅ 管理員看到「查看所有成員進度」核取方塊
- ✅ 勾選時顯示全隊進度
- ✅ 未勾選時只顯示個人進度
- ✅ 一般成員無核取方塊
- ✅ 一般成員只能看自己的進度
- ✅ 切換即時生效

#### 失敗排查
- 如果核取方塊未顯示 → 檢查 `UpdateWork.tsx` 的 `isManager` 狀態
- 如果切換無效 → 檢查 Console，確認 API 呼叫正確
- 如果成員看到核取方塊 → 檢查 `checkManagerRole()` 函數

---

### 測試 8: 支援多個管理員
**目標**: 驗證團隊可以有多個管理員，所有管理員擁有完整權限

#### 步驟
1. 以管理員 `admin` 登入
2. 導航至「團隊管理」
3. 提升 `user1` 為管理員
4. **驗證**: `user1` 角色變為「管理員」

5. 提升 `user2` 為管理員
6. **驗證**: 
   - `user2` 角色變為「管理員」
   - 統計卡片顯示「管理員數量: 3」

7. 登出，以 `user1` 登入
8. 導航至「團隊管理」
9. **驗證**: `user1` 可以執行管理操作：
   - 編輯團隊資訊
   - 提升/降級其他成員
   - 移除成員
   - 但無法修改自己的角色

10. 嘗試降級 `user2` 為成員
11. **驗證**: 降級成功
12. **驗證**: 統計卡片顯示「管理員數量: 2」

13. 以 `user2`（現為成員）登入
14. 導航至「團隊管理」
15. **驗證**: 
    - 無法編輯團隊資訊
    - 無法修改成員角色
    - 無法移除成員

#### 預期結果
- ✅ 可以同時存在多個管理員
- ✅ 所有管理員擁有完整權限
- ✅ 管理員無法修改自己的角色
- ✅ 降級後立即失去管理權限
- ✅ 統計數字正確反映管理員數量

#### 失敗排查
- 如果無法提升多人 → 檢查資料庫是否有單一管理員限制
- 如果權限不正確 → 檢查 `team.service.ts` 的權限檢查邏輯
- 如果可以修改自己角色 → 檢查 `updateMemberRole()` 函數

---

### 測試 9: AI 回應格式優化
**目標**: 驗證所有 AI 回應都使用 Markdown 正確渲染

#### 測試位置 1: WorkItems 頁面
1. 導航至「新增工作項目」
2. 新增幾個工作項目
3. 觀察右側 AI 總結面板
4. **驗證格式**:
   - **標題**: `## 今日工作總覽` 應顯示為大標題
   - **列表**: 應有適當縮排和符號（• 或 1.）
   - **粗體**: `**重要**` 應加粗
   - **段落間距**: 應有適當空白

#### 測試位置 2: DailySummary 頁面
5. 導航至「每日總結」
6. 生成一份總結
7. **驗證格式**:
   - **H1 標題**: 藍色，24px
   - **H2 標題**: 藍色，20px
   - **列表項**: 縮排 25px
   - **表格**: 如有，應有邊框和斑馬紋
   - **程式碼區塊**: 如有，應有灰色背景

#### 測試 Markdown 元素
8. 在對話框測試特殊 Markdown：
   ```markdown
   請生成包含以下格式的總結：
   - **粗體文字**
   - *斜體文字*
   - `行內程式碼`
   - [連結](https://example.com)
   
   ### 子標題測試
   
   > 這是引用區塊
   
   | 欄位1 | 欄位2 |
   |-------|-------|
   | A     | B     |
   ```

9. **驗證**: 所有格式正確渲染

#### 預期結果
- ✅ 標題層級正確（H1 > H2 > H3）
- ✅ 列表縮排和符號正確
- ✅ 粗體、斜體、程式碼正確渲染
- ✅ 表格有邊框和樣式
- ✅ 引用區塊有左邊框
- ✅ 連結可點擊
- ✅ 整體排版美觀專業

#### 失敗排查
- 如果 Markdown 未渲染 → 確認 `react-markdown` 已安裝
- 如果樣式錯誤 → 檢查 `.markdown-content` CSS 類別
- 如果顯示原始 Markdown → 確認使用 `<ReactMarkdown>` 包裹

---

### 測試 10: 每日總結儲存功能
**目標**: 驗證每日總結會儲存到資料庫，支援緩存和歷史查看

#### 步驟 A: 首次生成
1. 導航至「每日總結」頁面
2. 選擇今日日期（預設）
3. 點擊「生成總結」按鈕
4. **驗證**: 
   - 顯示 loading 動畫
   - AI 生成總結（可能需要 5-10 秒）
   - 總結內容正確顯示
   - 顯示「AI 生成」徽章

5. **檢查資料庫**:
   ```sql
   SELECT * FROM daily_summaries 
   WHERE team_id = 1 AND summary_date = CURRENT_DATE;
   ```
6. **驗證**: 應有一筆記錄

#### 步驟 B: 緩存測試
7. 刷新頁面（F5）
8. 再次點擊「生成總結」（相同日期）
9. **驗證**: 
   - 載入速度很快（< 1 秒）
   - 顯示「已儲存」徽章（綠色）
   - 內容與之前相同（從緩存載入）

10. **檢查 Network**:
    - 打開 F12 → Network
    - 確認 API 回應包含 `"cached": true`

#### 步驟 C: 歷史查看
11. 點擊「查看歷史」按鈕
12. **驗證**: 
    - 展開歷史列表面板
    - 顯示最近的總結記錄
    - 每筆記錄顯示：日期、生成者、生成時間

13. 點擊列表中的一個日期
14. **驗證**: 
    - 載入該日期的總結
    - 日期選擇器自動更新為選中日期
    - 總結內容正確顯示
    - 顯示「已儲存」徽章

15. 切換多個歷史日期
16. **驗證**: 每次切換都正確載入對應內容

#### 步驟 D: 跨日測試
17. 選擇昨天的日期（或任何過去日期）
18. 點擊「生成總結」
19. **驗證**: 
    - 如果該日期有工作記錄，生成總結
    - 如果無工作記錄，顯示適當訊息
20. **驗證**: 歷史列表包含新生成的日期

#### 預期結果
- ✅ 首次生成總結會儲存到資料庫
- ✅ 再次請求相同日期返回緩存（不重新生成）
- ✅ 顯示「已儲存」徽章標識緩存
- ✅ 歷史列表正確顯示
- ✅ 點擊歷史項目載入對應總結
- ✅ 跨日期切換正常
- ✅ 資料庫 UNIQUE 約束生效（不重複儲存）

#### 失敗排查
- 如果緩存未生效 → 檢查 `ai.service.ts` 的 `generateDailySummary()` 查詢邏輯
- 如果歷史列表為空 → 檢查 `getDailySummaryHistory()` API
- 如果「已儲存」徽章未顯示 → 檢查 API 回應的 `cached` 欄位
- 如果重複儲存 → 檢查資料庫 UNIQUE 約束是否生效

---

## 📊 整合測試

### 完整流程測試

#### 情境：一天的工作流程
1. **早上 9:00 - 打卡並新增工作項目**
   - 登入系統
   - 打卡
   - 新增 3-5 個今日工作項目
   - 確認 AI 總結正確生成

2. **中午 12:00 - 檢查進度**
   - 查看今日工作項目
   - 如果是管理員，查看全隊進度

3. **下午 5:00 - 更新工作進度**
   - 更新每個工作項目的完成狀態
   - 撰寫進度說明

4. **下午 6:00 - 生成每日總結**
   - 開啟「每日總結」頁面
   - 生成今日總結
   - 檢查總結內容是否準確
   - 確認儲存成功

5. **第二天 - 查看歷史**
   - 打卡
   - 新增今日工作項目
   - 查看昨日總結
   - 對比昨日計劃與今日安排

#### 預期結果
- ✅ 整個流程順暢無卡頓
- ✅ 資料正確儲存和讀取
- ✅ AI 功能正常運作
- ✅ 權限控制正確
- ✅ 時區和日期計算準確

---

## 🐛 常見問題排查

### 前端問題

#### Q1: 頁面白屏或載入失敗
**可能原因**:
- 前端編譯錯誤
- API 連線失敗

**排查步驟**:
1. 打開 F12 → Console
2. 查看錯誤訊息
3. 檢查 Network 標籤，確認 API 呼叫狀態
4. 確認後端伺服器運行中

#### Q2: AI 總結不生成
**可能原因**:
- vLLM API 未運行
- API 地址錯誤
- 網路連線問題

**排查步驟**:
1. 檢查後端 Console 是否有 AI API 錯誤
2. 確認 `.env` 檔案中 `VLLM_API_URL` 正確
3. 測試 vLLM API:
   ```powershell
   curl http://ai-api.example.com:8001/v1/models
   ```

#### Q3: 資料不更新
**可能原因**:
- 緩存問題
- State 未正確更新

**排查步驟**:
1. 刷新頁面（F5）
2. 清除瀏覽器緩存（Ctrl+Shift+Delete）
3. 檢查 React DevTools 的 Component State

### 後端問題

#### Q4: 資料庫連線失敗
**錯誤訊息**: `Error: connect ECONNREFUSED`

**排查步驟**:
1. 確認 PostgreSQL 運行中
2. 檢查 `.env` 檔案的資料庫設定
3. 測試資料庫連線:
   ```powershell
   psql -h db.example.com -p 5432 -U your_user -d ecoboard
   ```

#### Q5: 權限錯誤
**錯誤訊息**: `Permission denied` 或 `Forbidden`

**排查步驟**:
1. 確認已登入（token 有效）
2. 檢查使用者角色（admin/member）
3. 檢查後端 Console 的權限檢查日誌

#### Q6: 時區問題
**症狀**: 打卡日期不正確

**排查步驟**:
1. 檢查伺服器系統時間:
   ```powershell
   Get-Date
   ```
2. 確認 `getTodayDate()` 函數使用 UTC+8
3. 檢查資料庫的 `checkin_date` 欄位

---

## ✅ 測試完成檢查清單

### 功能測試
- [ ] 1. 工作項目刪除 ✅
- [ ] 2. WorkItems 即時總結 ✅
- [ ] 3. 對話式編輯 ✅
- [ ] 4. 團隊管理 ✅
- [ ] 6. 打卡準確性 ✅
- [ ] 7. 工作進度權限 ✅
- [ ] 8. 多個管理員 ✅
- [ ] 9. AI 格式優化 ✅
- [ ] 10. 每日總結儲存 ✅

### 非功能測試
- [ ] 效能: 頁面載入 < 2 秒
- [ ] 效能: API 回應 < 1 秒
- [ ] 相容性: Chrome 測試通過
- [ ] 相容性: Firefox 測試通過
- [ ] 響應式: 手機版布局正常
- [ ] 安全性: 權限控制正確
- [ ] 穩定性: 無記憶體洩漏

### 資料完整性
- [ ] 所有 CRUD 操作正確
- [ ] 級聯刪除正常運作
- [ ] 資料庫約束生效
- [ ] 備份機制確認

---

## 📝 測試報告範本

### 測試環境
- **測試日期**: YYYY-MM-DD
- **測試人員**: 您的姓名
- **前端版本**: 1.0.0
- **後端版本**: 1.0.0
- **資料庫版本**: PostgreSQL 14.x

### 測試結果總覽
| 功能項目 | 測試狀態 | 發現問題 | 嚴重程度 |
|---------|---------|---------|---------|
| 工作項目刪除 | ✅ 通過 | - | - |
| WorkItems 總結 | ✅ 通過 | - | - |
| 對話式編輯 | ✅ 通過 | - | - |
| 團隊管理 | ✅ 通過 | - | - |
| 打卡準確性 | ✅ 通過 | - | - |
| 工作進度權限 | ✅ 通過 | - | - |
| 多個管理員 | ✅ 通過 | - | - |
| AI 格式優化 | ✅ 通過 | - | - |
| 每日總結儲存 | ✅ 通過 | - | - |

### 發現的問題
（無或列出具體問題）

### 建議改進
（列出任何改進建議）

### 測試結論
（系統是否可以上線）

---

## 🚀 下一步

測試完成後：
1. 填寫測試報告
2. 修復發現的 bug（如有）
3. 進行使用者驗收測試（UAT）
4. 準備生產環境部署

**恭喜！您已完成 EcoBoard 的完整測試流程！** 🎉

---

**文件版本**: 1.0  
**最後更新**: 2025年1月
